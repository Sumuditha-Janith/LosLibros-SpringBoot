<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Publishers - LosLibros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    body {
      display: none;
      background-color: #f8f9fa;
    }
    .action-buttons {
      white-space: nowrap;
    }
    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container" style="margin-top: 80px;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Manage Publishers</h2>
    <span class="badge bg-primary" id="userRoleInfo"></span>
  </div>

  <div class="d-flex justify-content-between mb-3">
    <button class="btn btn-primary" id="addPublisherBtn">
      <i class="fas fa-plus me-1"></i> Add New Publisher
    </button>
    <div class="d-flex gap-2">
      <input type="text" class="form-control" id="searchInput" placeholder="Search publishers..." style="width: 250px;">
      <button class="btn btn-outline-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>
  </div>

  <div class="alert alert-info" id="loadingAlert">
    <i class="fas fa-spinner fa-spin me-2"></i> Loading publishers...
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover" id="publishersTable">
      <thead class="table-dark">
      <tr>
        <th>Name</th>
        <th>Number of Books</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      <!-- Publishers will be populated here -->
      </tbody>
    </table>
  </div>

  <div class="alert alert-warning" id="noPublishersAlert" style="display: none;">
    <i class="fas fa-exclamation-circle me-2"></i> No publishers found.
  </div>
</div>

<!-- Add/Edit Publisher Modal -->
<div class="modal fade" id="publisherModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add New Publisher</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="publisherForm">
          <input type="hidden" id="publisherId">
          <div class="mb-3">
            <label for="publisherName" class="form-label">Name *</label>
            <input type="text" class="form-control" id="publisherName" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="savePublisherBtn">Save Publisher</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the publisher "<span id="deletePublisherName"></span>"?</p>
        <p class="text-danger">This action cannot be undone. All books by this publisher will need to be reassigned.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/api.js"></script>
<script src="../js/navbar.js"></script>
<script>
  let currentPublisherId = null;
  let allPublishers = [];

  $(document).ready(function() {
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');

    if (!token) {
      window.location.href = 'signIn.html';
      return;
    }

    // Show page content
    $('body').show();
    $('#userRoleInfo').text(`Role: ${role}`);

    // Hide add button for USER role
    if (role === 'USER') {
      $('#addPublisherBtn').hide();
    }

    // Load publishers data
    loadPublishers();

    // Set up event listeners
    $('#addPublisherBtn').on('click', showAddModal);
    $('#savePublisherBtn').on('click', savePublisher);
    $('#refreshBtn').on('click', loadPublishers);
    $('#searchInput').on('keyup', filterPublishers);

    // Initialize modals
    const publisherModal = new bootstrap.Modal(document.getElementById('publisherModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Handle modal hidden event
    $('#publisherModal').on('hidden.bs.modal', function() {
      $('#publisherForm')[0].reset();
      $('#publisherId').val('');
      currentPublisherId = null;
    });
  });

  function showAddModal() {
    $('#modalTitle').text('Add New Publisher');
    const publisherModal = new bootstrap.Modal(document.getElementById('publisherModal'));
    publisherModal.show();
  }

  function showEditModal(publisherId) {
    const publisher = allPublishers.find(p => p.publisherId === publisherId);
    if (!publisher) return;

    $('#modalTitle').text('Edit Publisher');
    $('#publisherId').val(publisher.publisherId);
    $('#publisherName').val(publisher.publisherName);

    const publisherModal = new bootstrap.Modal(document.getElementById('publisherModal'));
    publisherModal.show();
  }

  function showDeleteModal(publisherId) {
    const publisher = allPublishers.find(p => p.publisherId === publisherId);
    if (!publisher) return;

    $('#deletePublisherName').text(publisher.publisherName);
    currentPublisherId = publisherId;

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
  }

  function savePublisher() {
    const publisherId = $('#publisherId').val();
    const publisherData = {
      publisherName: $('#publisherName').val()
    };

    if (!publisherData.publisherName) {
      Swal.fire({
        icon: 'error',
        title: 'Missing Information',
        text: 'Please fill in the publisher name',
        confirmButtonColor: '#0d6efd'
      });
      return;
    }

    const url = publisherId ? `/api/v1/publishers/${publisherId}` : '/api/v1/publishers/save';
    const method = publisherId ? 'PUT' : 'POST';

    makeApiCall(url, method, publisherData)
            .then(newPublisher => {
              Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: `Publisher ${publisherId ? 'updated' : 'added'} successfully!`,
                confirmButtonColor: '#0d6efd'
              });
              $('#publisherModal').modal('hide');
              loadPublishers();
            })
            .catch(error => {
              Swal.fire({
                icon: 'error',
                title: publisherId ? 'Update Failed' : 'Add Failed',
                text: `Failed to ${publisherId ? 'update' : 'add'} publisher: ${error}`,
                confirmButtonColor: '#0d6efd'
              });
            });
  }

  function deletePublisher() {
    if (!currentPublisherId) return;

    makeApiCall(`/api/v1/publishers/${currentPublisherId}`, 'DELETE')
            .then(() => {
              Swal.fire({
                icon: 'success',
                title: 'Deleted!',
                text: 'Publisher deleted successfully!',
                confirmButtonColor: '#0d6efd'
              });
              $('#deleteModal').modal('hide');
              loadPublishers();
            })
            .catch(error => {
              Swal.fire({
                icon: 'error',
                title: 'Delete Failed',
                text: 'Failed to delete publisher: ' + error,
                confirmButtonColor: '#0d6efd'
              });
            });
  }

  function loadPublishers() {
    $('#loadingAlert').show();
    $('#noPublishersAlert').hide();

    makeApiCall('/api/v1/publishers/getAllPub', 'GET')
            .then(publishers => {
              allPublishers = publishers;
              displayPublishers(publishers);
              $('#loadingAlert').hide();
            })
            .catch(error => {
              console.error('Failed to load publishers:', error);
              $('#loadingAlert').hide();
              $('#noPublishersAlert').show();
            });
  }

  function displayPublishers(publishers) {
    const tbody = $('#publishersTable tbody');
    tbody.empty();

    if (publishers.length === 0) {
      $('#noPublishersAlert').show();
      return;
    }

    publishers.forEach(publisher => {
      const row = `
                <tr>
                    <td>${publisher.publisherName}</td>
                    <td>${publisher.bookCount || 0}</td>
                    <td class="action-buttons">
                        ${getActionButtons(publisher.publisherId)}
                    </td>
                </tr>
            `;
      tbody.append(row);
    });

    // Add event listeners to action buttons
    $('.edit-publisher').on('click', function() {
      showEditModal($(this).data('id'));
    });

    $('.delete-publisher').on('click', function() {
      showDeleteModal($(this).data('id'));
    });
  }

  function getActionButtons(publisherId) {
    const role = localStorage.getItem('role');
    let buttons = '';

    if (role === 'ADMIN' || role === 'EMPLOYEE') {
      buttons += `
                <button class="btn btn-sm btn-warning edit-publisher" data-id="${publisherId}" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
            `;
    }

    if (role === 'ADMIN') {
      buttons += `
                <button class="btn btn-sm btn-danger delete-publisher" data-id="${publisherId}" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            `;
    }

    return buttons;
  }

  function filterPublishers() {
    const searchTerm = $('#searchInput').val().toLowerCase();
    if (!searchTerm) {
      displayPublishers(allPublishers);
      return;
    }

    const filteredPublishers = allPublishers.filter(publisher =>
            publisher.publisherName.toLowerCase().includes(searchTerm)
    );

    displayPublishers(filteredPublishers);
  }

  // Set up delete confirmation
  $('#confirmDeleteBtn').on('click', deletePublisher);
</script>
</body>
</html>