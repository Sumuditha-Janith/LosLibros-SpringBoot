<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Publisher Sales - LosLibros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            display: none;
            background-color: #f8f9fa;
        }
        .sidebar {
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            padding-top: 20px;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            margin: 5px 0;
        }
        .sidebar .nav-link:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            color: white;
            background-color: #0d6efd;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .sale-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .sale-card:hover {
            transform: translateY(-5px);
        }
        .countdown {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .active-sale {
            border-left: 4px solid #198754;
        }
        .upcoming-sale {
            border-left: 4px solid #ffc107;
        }
        .expired-sale {
            border-left: 4px solid #6c757d;
            opacity: 0.7;
        }
    </style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
    <div class="text-center mb-4">
        <h4><i class="fas fa-book me-2"></i>LosLibros</h4>
        <p class="text-muted">Admin Dashboard</p>
    </div>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="adminDashboard.html">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="books.html">
                <i class="fas fa-book me-2"></i>Books
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="authors.html">
                <i class="fas fa-user-tie me-2"></i>Authors
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="categories.html">
                <i class="fas fa-tags me-2"></i>Categories
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="publishers.html">
                <i class="fas fa-building me-2"></i>Publishers
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="users.html">
                <i class="fas fa-users me-2"></i>Users
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="adminPublisherSales.html">
                <i class="fas fa-percent me-2"></i>Publisher Sales
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="orderManagement.html">
                <i class="fas fa-clipboard-list me-2"></i>Order Management
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
        </li>
    </ul>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Publisher Sales</h2>
        <div>
            <span class="badge bg-primary" id="userInfo">Welcome, Admin</span>
        </div>
    </div>

    <!-- Create Sale Form -->
    <div class="card mb-4 sale-card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Publisher Sale</h5>
        </div>
        <div class="card-body">
            <form id="saleForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="publisherSelect" class="form-label">Publisher *</label>
                        <select class="form-select" id="publisherSelect" required>
                            <option value="">Select Publisher</option>
                            <!-- Publishers will be populated here -->
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="saleDescription" class="form-label">Sale Description *</label>
                        <input type="text" class="form-control" id="saleDescription" placeholder="Summer Sale, Holiday Special, etc." required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="discountPercentage" class="form-label">Discount Percentage *</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="discountPercentage" min="1" max="100" step="1" required>
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="startDate" class="form-label">Start Date *</label>
                        <input type="datetime-local" class="form-control" id="startDate" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="endDate" class="form-label">End Date *</label>
                        <input type="datetime-local" class="form-control" id="endDate" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-2"></i>Create Sale
                </button>
            </form>
        </div>
    </div>

    <!-- Active Sales -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-fire me-2"></i>Active Sales</h5>
        </div>
        <div class="card-body">
            <div id="activeSalesContainer" class="row">
                <!-- Active sales will be populated here -->
            </div>
            <div class="alert alert-info mt-3" id="noActiveSales">
                <i class="fas fa-info-circle me-2"></i> No active sales at the moment.
            </div>
        </div>
    </div>

    <!-- Upcoming Sales -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Upcoming Sales</h5>
        </div>
        <div class="card-body">
            <div id="upcomingSalesContainer" class="row">
                <!-- Upcoming sales will be populated here -->
            </div>
            <div class="alert alert-info mt-3" id="noUpcomingSales">
                <i class="fas fa-info-circle me-2"></i> No upcoming sales scheduled.
            </div>
        </div>
    </div>

    <!-- Past Sales -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Past Sales</h5>
        </div>
        <div class="card-body">
            <div id="pastSalesContainer" class="row">
                <!-- Past sales will be populated here -->
            </div>
            <div class="alert alert-info mt-3" id="noPastSales">
                <i class="fas fa-info-circle me-2"></i> No past sales recorded.
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the sale "<span id="deleteSaleDescription"></span>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/api.js"></script>
<script>
    let currentSaleId = null;
    let allPublishers = [];

    $(document).ready(function() {
        // Check authentication
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = 'signIn.html';
            return;
        }

        // Show page content but don't load data yet
        $('body').show();
        $('#userInfo').text(`Welcome, ${username} (${role})`);

        // First verify user role from API, then load data
        verifyUserRoleAndLoadData();

        // Logout functionality
        $('#logoutBtn').on('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            window.location.href = '../index.html';
        });

        // Set up event listeners
        $('#saleForm').on('submit', createSale);
        $('#confirmDeleteBtn').on('click', deleteSale);

        // Set minimum datetime for start and end dates
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000;
        const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);

        $('#startDate').attr('min', localISOTime);
        $('#endDate').attr('min', localISOTime);

        // Update end date min when start date changes
        $('#startDate').on('change', function() {
            $('#endDate').attr('min', $(this).val());
        });
    });

    function verifyUserRoleAndLoadData() {
        // First get user info from API to verify role
        makeApiCall('/api/v1/users/info', 'GET')
            .then(response => {
                const userRole = response.role;
                $('#userInfo').text(`Welcome, ${response.username} (${userRole})`);

                // Update localStorage with actual role from server
                localStorage.setItem('role', userRole);

                if (userRole !== 'ADMIN') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Access Denied',
                        text: 'You need admin privileges to access this page.',
                        confirmButtonColor: '#0d6efd'
                    }).then(() => {
                        window.location.href = userRole === 'EMPLOYEE' ? 'employeeDashboard.html' : 'userDashboard.html';
                    });
                    return;
                }

                // User is confirmed ADMIN, now load all data
                loadSales();
                loadPublishers();

            })
            .catch(error => {
                console.error('Failed to verify user role:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Authentication Error',
                    text: 'Failed to verify user permissions. Please login again.',
                    confirmButtonColor: '#0d6efd'
                }).then(() => {
                    window.location.href = 'signIn.html';
                });
            });
    }

    function loadPublishers() {
        makeApiCall('/api/v1/publishers/getAllPub', 'GET')
            .then(publishers => {
                allPublishers = publishers;
                const dropdown = $('#publisherSelect');
                dropdown.empty();
                dropdown.append('<option value="">Select Publisher</option>');
                publishers.forEach(publisher => {
                    dropdown.append(`<option value="${publisher.publisherId}">${publisher.publisherName}</option>`);
                });
            })
            .catch(error => {
                console.error('Failed to load publishers:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Load Error',
                    text: 'Failed to load publishers. Please refresh the page.',
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    function createSale(e) {
        e.preventDefault();

        const publisherId = $('#publisherSelect').val();
        const saleDescription = $('#saleDescription').val();
        const discountPercentage = $('#discountPercentage').val();

        const startDate = new Date($('#startDate').val());
        const endDate = new Date($('#endDate').val());

        if (endDate <= startDate) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Date',
                text: 'End date must be after start date',
                confirmButtonColor: '#0d6efd'
            });
            return;
        }

        if (startDate < new Date()) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Date',
                text: 'Start date cannot be in the past',
                confirmButtonColor: '#0d6efd'
            });
            return;
        }

        if (!publisherId || !saleDescription || !discountPercentage || !startDate || !endDate) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Please fill in all required fields',
                confirmButtonColor: '#0d6efd'
            });
            return;
        }

        const saleData = {
            publisherId: parseInt(publisherId),
            saleDescription: saleDescription,
            discountPercentage: parseFloat(discountPercentage),
            startDate: new Date(startDate).toISOString(),
            endDate: new Date(endDate).toISOString()
        };

        makeApiCall('/api/v1/sales', 'POST', saleData)
            .then(sale => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Sale created successfully!',
                    confirmButtonColor: '#0d6efd'
                });
                $('#saleForm')[0].reset();
                loadSales();
            })
            .catch(error => {
                console.error('Failed to create sale:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Create Failed',
                    text: 'Failed to create sale: ' + error,
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    function loadSales() {
        makeApiCall('/api/v1/sales', 'GET')
            .then(sales => {
                const now = new Date();

                // Filter sales by status
                const activeSales = sales.filter(sale =>
                    new Date(sale.startDate) <= now && new Date(sale.endDate) >= now
                );

                const upcomingSales = sales.filter(sale =>
                    new Date(sale.startDate) > now
                );

                const pastSales = sales.filter(sale =>
                    new Date(sale.endDate) < now
                );

                // Display sales
                displaySales(activeSales, 'activeSalesContainer', 'noActiveSales', 'active');
                displaySales(upcomingSales, 'upcomingSalesContainer', 'noUpcomingSales', 'upcoming');
                displaySales(pastSales, 'pastSalesContainer', 'noPastSales', 'expired');
            })
            .catch(error => {
                console.error('Failed to load sales:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Load Error',
                    text: 'Failed to load sales. Please refresh the page.',
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    function displaySales(sales, containerId, noSalesId, status) {
        const container = $(`#${containerId}`);
        const noSalesAlert = $(`#${noSalesId}`);

        container.empty();

        if (sales.length === 0) {
            noSalesAlert.show();
            return;
        }

        noSalesAlert.hide();

        sales.forEach(sale => {
            const saleCard = createSaleCard(sale, status);
            container.append(saleCard);
        });

        // Add event listeners to delete buttons
        $(`.delete-sale-${status}`).on('click', function() {
            const saleId = $(this).data('id');
            showDeleteModal(saleId);
        });
    }

    function createSaleCard(sale, status) {
        const now = new Date();
        const startDate = new Date(sale.startDate);
        const endDate = new Date(sale.endDate);

        let statusClass = '';
        let statusText = '';
        let countdownHtml = '';

        if (status === 'active') {
            statusClass = 'active-sale';
            statusText = '<span class="badge bg-success">Active</span>';
            countdownHtml = `<div class="mt-2">
                <small class="text-muted">Ends in: </small>
                <span class="countdown" data-end="${endDate.getTime()}"></span>
            </div>`;
        } else if (status === 'upcoming') {
            statusClass = 'upcoming-sale';
            statusText = '<span class="badge bg-warning text-dark">Upcoming</span>';
            countdownHtml = `<div class="mt-2">
                <small class="text-muted">Starts in: </small>
                <span class="countdown" data-start="${startDate.getTime()}"></span>
            </div>`;
        } else {
            statusClass = 'expired-sale';
            statusText = '<span class="badge bg-secondary">Expired</span>';
        }

        const publisher = allPublishers.find(p => p.publisherId === sale.publisherId);
        const publisherName = publisher ? publisher.publisherName : 'Unknown Publisher';

        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 ${statusClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title">${sale.saleDescription}</h5>
                            ${statusText}
                        </div>
                        <h6 class="card-subtitle mb-2 text-muted">${publisherName}</h6>
                        <p class="card-text">
                            <strong>Discount:</strong> ${sale.discountPercentage}%<br>
                            <strong>Start:</strong> ${formatDateTime(startDate)}<br>
                            <strong>End:</strong> ${formatDateTime(endDate)}
                        </p>
                        ${countdownHtml}
                    </div>
                    <div class="card-footer bg-transparent">
                        <button class="btn btn-sm btn-danger delete-sale-${status}" data-id="${sale.id}">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function formatDateTime(date) {
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showDeleteModal(saleId) {
        // Find the sale to get its description
        makeApiCall(`/api/v1/sales/${saleId}`, 'GET')
            .then(sale => {
                $('#deleteSaleDescription').text(sale.saleDescription);
                currentSaleId = saleId;

                const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                deleteModal.show();
            })
            .catch(error => {
                console.error('Failed to get sale details:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to get sale details. Please try again.',
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    function deleteSale() {
        if (!currentSaleId) return;

        makeApiCall(`/api/v1/sales/${currentSaleId}`, 'DELETE')
            .then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: 'Sale deleted successfully!',
                    confirmButtonColor: '#0d6efd'
                });
                $('#deleteModal').modal('hide');
                loadSales();
            })
            .catch(error => {
                console.error('Failed to delete sale:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Delete Failed',
                    text: 'Failed to delete sale: ' + error,
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    // Initialize countdown timers
    function initializeCountdowns() {
        $('.countdown').each(function() {
            const element = $(this);
            const endTime = element.data('end');
            const startTime = element.data('start');
            const targetTime = endTime || startTime;
            const isStartCountdown = !!startTime;

            function updateCountdown() {
                const now = new Date().getTime();
                const distance = targetTime - now;

                if (distance < 0) {
                    element.text('00:00:00:00');
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                element.text(`${days}d ${hours}h ${minutes}m ${seconds}s`);
            }

            updateCountdown();
            setInterval(updateCountdown, 1000);
        });
    }

    // Initialize countdowns when page is loaded and after sales are loaded
    setTimeout(initializeCountdowns, 1000);
</script>
</body>
</html>