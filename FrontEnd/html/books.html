<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Books - LosLibros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 76px; /* Account for fixed navbar */
        }
        .book-image {
            max-width: 100px;
            max-height: 150px;
            object-fit: cover;
        }
        .book-image-preview {
            max-width: 200px;
            max-height: 300px;
            object-fit: cover;
            display: none;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            position: relative;
        }
        .upload-area:hover {
            border-color: #0d6efd;
        }
        .progress {
            height: 20px;
            margin-bottom: 15px;
            display: none;
        }
        #imageUpload {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .admin-only { display: none; }
    </style>
</head>
<body>
<!-- Navbar Container -->
<div id="navbar-container"></div>

<!-- Main Content -->
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <h2>Manage Books</h2>
        <div>
            <span class="badge bg-primary" id="userInfo">Welcome, Admin</span>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5 id="formTitle">Add New Book</h5>
        </div>
        <div class="card-body">
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="bookTitle" class="form-label">Book Title</label>
                            <input type="text" class="form-control" id="bookTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookPrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="bookPrice" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="bookQuantity" required>
                        </div>
                        <div class="mb-3">
                            <label for="bookAuthor" class="form-label">Author</label>
                            <select class="form-control" id="bookAuthor" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="bookCategory" class="form-label">Category</label>
                            <select class="form-control" id="bookCategory" required></select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Book Image</label>
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-2"></i>
                                <p>Click or drag image to upload</p>
                                <input type="file" id="imageUpload" accept="image/*">
                            </div>
                            <div class="progress" id="uploadProgress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <img id="imagePreview" class="book-image-preview img-thumbnail">
                            <input type="hidden" id="bookImage">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Book</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5>Book List</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Image</th>
                        <th>Title</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Author</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="bookTableBody">
                    <!-- Books will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this book?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/navbar.js"></script>
<script>
    const IMGBB_API_KEY = '40afd4d2258cabdd429760a26e3e3658';
    let books = [];
    let authors = [];
    let categories = [];
    let deleteBookId = null;

    $(document).ready(function() {
        // Check authentication
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = 'signIn.html';
            return;
        }

        // Show page content
        $('#userInfo').text(`Welcome, ${username} (${role})`);

        // Verify user role
        verifyUserRole();

        // Setup event listeners
        setupEventListeners();

        // Load initial data
        loadAuthors();
        loadCategories();
        loadBooks();
    });

    function verifyUserRole() {
        makeApiCall('/api/v1/users/info', 'GET')
            .then(response => {
                const userRole = response.role;
                if (userRole !== 'ADMIN' && userRole !== 'EMPLOYEE') {
                    alert('Access denied. You need admin or employee privileges to manage books.');
                    window.location.href = userRole === 'USER' ? 'userDashboard.html' : 'signIn.html';
                }
            })
            .catch(error => {
                console.error('Failed to verify user role:', error);
                alert('Failed to verify user permissions. Please login again.');
                window.location.href = 'signIn.html';
            });
    }

    function setupEventListeners() {
        // Form submission
        $('#bookForm').on('submit', function(e) {
            e.preventDefault();
            saveBook();
        });

        // Cancel button
        $('#cancelBtn').on('click', function() {
            resetForm();
        });

        // File upload handling - fixed to work with click
        $('#imageUpload').on('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                uploadImage(e.target.files[0]);
            }
        });

        // Drag and drop for image upload
        $('#uploadArea').on('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).css('border-color', '#0d6efd');
            $(this).css('background-color', '#f8f9fa');
        });

        $('#uploadArea').on('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).css('border-color', '#ccc');
            $(this).css('background-color', '');
        });

        $('#uploadArea').on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).css('border-color', '#ccc');
            $(this).css('background-color', '');

            if (e.originalEvent.dataTransfer.files && e.originalEvent.dataTransfer.files[0]) {
                uploadImage(e.originalEvent.dataTransfer.files[0]);
            }
        });
    }

    function uploadImage(file) {
        // Check if file is an image
        if (!file.type.match('image.*')) {
            alert('Please select an image file');
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#imagePreview').attr('src', e.target.result).show();
        };
        reader.readAsDataURL(file);

        // Upload to ImgBB
        const formData = new FormData();
        formData.append('image', file);
        formData.append('key', IMGBB_API_KEY);

        $('#uploadProgress').show();
        $('#uploadArea').hide();

        $.ajax({
            url: 'https://api.imgbb.com/1/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        $('#uploadProgress .progress-bar').css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                if (response.success) {
                    $('#bookImage').val(response.data.url);
                    $('#uploadProgress').hide();
                    $('#uploadArea').show();
                    alert('Image uploaded successfully!');
                } else {
                    alert('Failed to upload image: ' + response.error.message);
                    $('#uploadProgress').hide();
                    $('#uploadArea').show();
                }
            },
            error: function() {
                alert('Failed to upload image. Please try again.');
                $('#uploadProgress').hide();
                $('#uploadArea').show();
            }
        });
    }

    function loadBooks() {
        makeApiCall('/api/v1/books/getAllBooks', 'GET')
            .then(data => {
                books = data;
                renderBooksTable();
            })
            .catch(error => {
                console.error('Failed to load books:', error);
                alert('Failed to load books');
            });
    }

    function loadAuthors() {
        makeApiCall('/api/v1/authors/getAllAuth', 'GET')
            .then(data => {
                authors = data;
                $('#bookAuthor').empty();
                authors.forEach(author => {
                    $('#bookAuthor').append(`<option value="${author.authorId}">${author.authorName}</option>`);
                });
            })
            .catch(error => {
                console.error('Failed to load authors:', error);
            });
    }

    function loadCategories() {
        makeApiCall('/api/v1/categories/getAllCat', 'GET')
            .then(data => {
                categories = data;
                $('#bookCategory').empty();
                categories.forEach(category => {
                    $('#bookCategory').append(`<option value="${category.categoryId}">${category.categoryName}</option>`);
                });
            })
            .catch(error => {
                console.error('Failed to load categories:', error);
            });
    }

    function renderBooksTable() {
        const tableBody = $('#bookTableBody');
        tableBody.empty();

        if (books.length === 0) {
            tableBody.append('<tr><td colspan="7" class="text-center">No books found</td></tr>');
            return;
        }

        books.forEach(book => {
            const author = authors.find(a => a.authorId === book.bookAuthor.authorId) || {};
            const category = categories.find(c => c.categoryId === book.bookCategory.categoryId) || {};

            const row = `
                <tr>
                    <td>
                        ${book.bookImage ?
                `<img src="${book.bookImage}" class="book-image" alt="${book.bookTitle}">` :
                '<i class="fas fa-image text-muted"></i>'
            }
                    </td>
                    <td>${book.bookTitle}</td>
                    <td>$${book.bookPrice.toFixed(2)}</td>
                    <td>${book.bookQuantity}</td>
                    <td>${author.authorName || 'N/A'}</td>
                    <td>${category.categoryName || 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editBook(${book.bookId})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="showDeleteModal(${book.bookId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tableBody.append(row);
        });
    }

    function saveBook() {
        const bookId = $('#bookId').val();
        const bookData = {
            bookTitle: $('#bookTitle').val(),
            bookPrice: parseFloat($('#bookPrice').val()),
            bookQuantity: parseInt($('#bookQuantity').val()),
            bookImage: $('#bookImage').val(),
            bookAuthor: {
                authorId: parseInt($('#bookAuthor').val())
            },
            bookCategory: {
                categoryId: parseInt($('#bookCategory').val())
            }
        };

        const url = bookId ? `/api/v1/books/${bookId}` : '/api/v1/books/save';
        const method = bookId ? 'PUT' : 'POST';

        makeApiCall(url, method, bookData)
            .then(() => {
                alert(`Book ${bookId ? 'updated' : 'added'} successfully!`);
                resetForm();
                loadBooks();
            })
            .catch(error => {
                console.error('Failed to save book:', error);
                alert('Failed to save book: ' + error);
            });
    }

    function editBook(id) {
        const book = books.find(b => b.bookId === id);
        if (!book) return;

        $('#bookId').val(book.bookId);
        $('#bookTitle').val(book.bookTitle);
        $('#bookPrice').val(book.bookPrice);
        $('#bookQuantity').val(book.bookQuantity);
        $('#bookAuthor').val(book.bookAuthor.authorId);
        $('#bookCategory').val(book.bookCategory.categoryId);

        if (book.bookImage) {
            $('#bookImage').val(book.bookImage);
            $('#imagePreview').attr('src', book.bookImage).show();
        } else {
            $('#bookImage').val('');
            $('#imagePreview').hide();
        }

        $('#formTitle').text('Edit Book');
        $('#cancelBtn').show();
        $('html, body').animate({ scrollTop: 0 }, 'slow');
    }

    function showDeleteModal(id) {
        deleteBookId = id;
        $('#deleteModal').modal('show');
    }

    $('#confirmDelete').on('click', function() {
        if (deleteBookId) {
            makeApiCall(`/api/v1/books/${deleteBookId}`, 'DELETE')
                .then(() => {
                    alert('Book deleted successfully!');
                    $('#deleteModal').modal('hide');
                    loadBooks();
                })
                .catch(error => {
                    console.error('Failed to delete book:', error);
                    alert('Failed to delete book: ' + error);
                    $('#deleteModal').modal('hide');
                });
        }
    });

    function resetForm() {
        $('#bookForm')[0].reset();
        $('#bookId').val('');
        $('#bookImage').val('');
        $('#imagePreview').hide();
        $('#formTitle').text('Add New Book');
        $('#cancelBtn').hide();
    }
</script>
</body>
</html>