<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Books - LosLibros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: none;
            background-color: #f8f9fa;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .book-image {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 4px;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            display: none;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .upload-container {
            position: relative;
        }
        .upload-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        .progress {
            height: 8px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container" style="margin-top: 80px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Books</h2>
        <span class="badge bg-primary" id="userRoleInfo"></span>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" id="addBookBtn">
            <i class="fas fa-plus me-1"></i> Add New Book
        </button>
        <div class="d-flex gap-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Search books..." style="width: 250px;">
            <button class="btn btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div class="alert alert-info" id="loadingAlert">
        <i class="fas fa-spinner fa-spin me-2"></i> Loading books...
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="booksTable">
            <thead class="table-dark">
            <tr>
                <th>Image</th>
                <th>Title</th>
                <th>Description</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Author</th>
                <th>Category</th>
                <th>Publisher</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Books will be populated here -->
            </tbody>
        </table>
    </div>

    <div class="alert alert-warning" id="noBooksAlert" style="display: none;">
        <i class="fas fa-exclamation-circle me-2"></i> No books found.
    </div>
</div>

<!-- Add/Edit Book Modal -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookTitle" class="form-label">Title *</label>
                            <input type="text" class="form-control" id="bookTitle" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bookPrice" class="form-label">Price (LKR)</label>
                            <input type="number" class="form-control" id="bookPrice" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bookDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="bookDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="bookQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="bookQuantity" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="bookImage" class="form-label">Book Image</label>
                            <div class="upload-container">
                                <input type="text" class="form-control" id="bookImage" placeholder="Image URL or upload image" readonly>
                                <button type="button" class="btn btn-outline-primary upload-btn" id="uploadImageBtn">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                            </div>
                            <img id="imagePreview" class="image-preview" alt="Image preview">
                            <div class="progress mt-2" id="uploadProgress" style="display: none;">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="bookAuthor" class="form-label">Author *</label>
                            <select class="form-select" id="bookAuthor" required>
                                <option value="">Select Author</option>
                                <!-- Authors will be populated here -->
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="bookCategory" class="form-label">Category *</label>
                            <select class="form-select" id="bookCategory" required>
                                <option value="">Select Category</option>
                                <!-- Categories will be populated here -->
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="bookPublisher" class="form-label">Publisher</label>
                            <select class="form-select" id="bookPublisher">
                                <option value="">Select Publisher</option>
                                <!-- Publishers will be populated here -->
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBookBtn">Save Book</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the book "<span id="deleteBookTitle"></span>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Upload Modal -->
<div class="modal fade" id="imageUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Book Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="imageUpload" class="form-label">Select Image</label>
                    <input class="form-control" type="file" id="imageUpload" accept="image/*">
                </div>
                <div class="mb-3">
                    <img id="uploadPreview" class="image-preview" alt="Upload preview">
                </div>
                <div class="progress mb-3" id="uploadProgressModal" style="display: none;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmUploadBtn">Upload to ImgBB</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/navbar.js"></script>
<script>
    let currentBookId = null;
    let allBooks = [];
    let allAuthors = [];
    let allCategories = [];
    let allPublishers = [];
    let imageUploadModalInstance = null;
    const IMGBB_API_KEY = '40afd4d2258cabdd429760a26e3e3658';

    $(document).ready(function() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = 'signIn.html';
            return;
        }

        // Show page content
        $('body').show();
        $('#userRoleInfo').text(`Role: ${role}`);

        // Hide add button for USER role
        if (role === 'USER') {
            $('#addBookBtn').hide();
        }

        // Initialize modals
        imageUploadModalInstance = new bootstrap.Modal(document.getElementById('imageUploadModal'));

        // Load books data and dependencies
        loadAuthorsCategoriesAndPublishers().then(() => {
            loadBooks();
        });

        // Set up event listeners
        $('#addBookBtn').on('click', showAddModal);
        $('#saveBookBtn').on('click', saveBook);
        $('#refreshBtn').on('click', loadBooks);
        $('#searchInput').on('keyup', filterBooks);
        $('#uploadImageBtn').on('click', showImageUploadModal);
        $('#imageUpload').on('change', handleImageSelect);
        $('#confirmUploadBtn').on('click', uploadImageToImgBB);

        // Initialize modals
        const bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // Handle modal hidden event
        $('#bookModal').on('hidden.bs.modal', function() {
            $('#bookForm')[0].reset();
            $('#bookId').val('');
            $('#imagePreview').hide();
            $('#uploadProgress').hide();
            currentBookId = null;
        });
    });

    function loadAuthorsCategoriesAndPublishers() {
        return Promise.all([
            makeApiCall('/api/v1/authors/getAllAuth', 'GET')
                .then(authors => {
                    allAuthors = authors;
                    populateAuthorDropdown();
                }),
            makeApiCall('/api/v1/categories/getAllCat', 'GET')
                .then(categories => {
                    allCategories = categories;
                    populateCategoryDropdown();
                }),
            makeApiCall('/api/v1/publishers/getAllPub', 'GET')
                .then(publishers => {
                    allPublishers = publishers;
                    populatePublisherDropdown();
                })
        ]);
    }

    function populateAuthorDropdown() {
        const dropdown = $('#bookAuthor');
        dropdown.empty();
        dropdown.append('<option value="">Select Author</option>');
        allAuthors.forEach(author => {
            dropdown.append(`<option value="${author.authorId}">${author.authorName}</option>`);
        });
    }

    function populateCategoryDropdown() {
        const dropdown = $('#bookCategory');
        dropdown.empty();
        dropdown.append('<option value="">Select Category</option>');
        allCategories.forEach(category => {
            dropdown.append(`<option value="${category.categoryId}">${category.categoryName}</option>`);
        });
    }

    function populatePublisherDropdown() {
        const dropdown = $('#bookPublisher');
        dropdown.empty();
        dropdown.append('<option value="">Select Publisher (Optional)</option>');
        allPublishers.forEach(publisher => {
            dropdown.append(`<option value="${publisher.publisherId}">${publisher.publisherName}</option>`);
        });
    }

    function showAddModal() {
        $('#modalTitle').text('Add New Book');
        const bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
        bookModal.show();
    }

    function showEditModal(bookId) {
        const book = allBooks.find(b => b.bookId === bookId);
        if (!book) return;

        $('#modalTitle').text('Edit Book');
        $('#bookId').val(book.bookId);
        $('#bookTitle').val(book.bookTitle);
        $('#bookDescription').val(book.bookDescription || '');
        $('#bookPrice').val(book.bookPrice);
        $('#bookQuantity').val(book.bookQuantity);
        $('#bookImage').val(book.bookImage || '');
        $('#bookAuthor').val(book.bookAuthor?.authorId || '');
        $('#bookCategory').val(book.bookCategory?.categoryId || '');
        $('#bookPublisher').val(book.bookPublisher?.publisherId || '');

        // Show image preview if available
        if (book.bookImage) {
            $('#imagePreview').attr('src', book.bookImage).show();
        }

        const bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
        bookModal.show();
    }

    function showDeleteModal(bookId) {
        const book = allBooks.find(b => b.bookId === bookId);
        if (!book) return;

        $('#deleteBookTitle').text(book.bookTitle);
        currentBookId = bookId;

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function showImageUploadModal() {
        $('#imageUpload').val('');
        $('#uploadPreview').hide();
        $('#uploadProgressModal').hide();
        imageUploadModalInstance.show();
    }

    function handleImageSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Check file size (ImgBB limit is 32MB)
            if (file.size > 32 * 1024 * 1024) {
                alert('Image size must be less than 32MB');
                $('#imageUpload').val('');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                $('#uploadPreview').attr('src', e.target.result).show();
            };
            reader.readAsDataURL(file);
        }
    }

    function uploadImageToImgBB() {
        const fileInput = document.getElementById('imageUpload');
        const file = fileInput.files[0];

        if (!file) {
            alert('Please select an image to upload');
            return;
        }

        // Show progress bar
        $('#uploadProgressModal').show();
        const progressBar = $('#uploadProgressModal .progress-bar');
        progressBar.css('width', '10%');

        // Create form data
        const formData = new FormData();
        formData.append('image', file);

        // Update progress
        progressBar.css('width', '30%');

        // Upload to ImgBB
        $.ajax({
            url: 'https://api.imgbb.com/1/upload?key=' + IMGBB_API_KEY,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    progressBar.css('width', '100%');

                    // Set the image URL in the form
                    const imageUrl = response.data.url;
                    $('#bookImage').val(imageUrl);
                    $('#imagePreview').attr('src', imageUrl).show();

                    // Show success message
                    setTimeout(() => {
                        // Close the upload modal
                        imageUploadModalInstance.hide();
                        alert('Image uploaded successfully to ImgBB!');
                    }, 500);
                } else {
                    alert('Failed to upload image: ' + response.error.message);
                }
            },
            error: function(xhr, status, error) {
                alert('Failed to upload image: ' + error);
                console.error('ImgBB upload error:', error);
            },
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(evt) {
                    if (evt.lengthComputable) {
                        const percentComplete = (evt.loaded / evt.total) * 100;
                        progressBar.css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            }
        });
    }

    function saveBook() {
        const bookId = $('#bookId').val();
        const bookData = {
            bookTitle: $('#bookTitle').val(),
            bookDescription: $('#bookDescription').val() || '',
            bookPrice: parseFloat($('#bookPrice').val()),
            bookQuantity: parseInt($('#bookQuantity').val()),
            bookImage: $('#bookImage').val() || '',
            bookAuthor: {
                authorId: parseInt($('#bookAuthor').val())
            },
            bookCategory: {
                categoryId: parseInt($('#bookCategory').val())
            }
        };

        // Add publisher only if selected
        const publisherId = $('#bookPublisher').val();
        if (publisherId) {
            bookData.bookPublisher = {
                publisherId: parseInt(publisherId)
            };
        }

        if (!bookData.bookTitle || !bookData.bookPrice || !bookData.bookQuantity ||
            !bookData.bookAuthor.authorId || !bookData.bookCategory.categoryId) {
            alert('Please fill in all required fields');
            return;
        }

        const url = bookId ? `/api/v1/books/${bookId}` : '/api/v1/books/save';
        const method = bookId ? 'PUT' : 'POST';

        // Show progress in main form
        $('#uploadProgress').show();
        const progressBar = $('#uploadProgress .progress-bar');
        progressBar.css('width', '50%');

        makeApiCall(url, method, bookData)
            .then(newBook => {
                progressBar.css('width', '100%');
                setTimeout(() => {
                    alert(`Book ${bookId ? 'updated' : 'added'} successfully!`);
                    $('#bookModal').modal('hide');
                    loadBooks();
                }, 500);
            })
            .catch(error => {
                $('#uploadProgress').hide();
                alert(`Failed to ${bookId ? 'update' : 'add'} book: ` + error);
            });
    }

    function deleteBook() {
        if (!currentBookId) return;

        makeApiCall(`/api/v1/books/${currentBookId}`, 'DELETE')
            .then(() => {
                alert('Book deleted successfully!');
                $('#deleteModal').modal('hide');
                loadBooks();
            })
            .catch(error => {
                alert('Failed to delete book: ' + error);
            });
    }

    function loadBooks() {
        $('#loadingAlert').show();
        $('#noBooksAlert').hide();

        makeApiCall('/api/v1/books/getAllBooks', 'GET')
            .then(books => {
                allBooks = books;
                displayBooks(books);
                $('#loadingAlert').hide();
            })
            .catch(error => {
                console.error('Failed to load books:', error);
                $('#loadingAlert').hide();
                $('#noBooksAlert').show();
            });
    }

    function displayBooks(books) {
        const tbody = $('#booksTable tbody');
        tbody.empty();

        if (books.length === 0) {
            $('#noBooksAlert').show();
            return;
        }

        books.forEach(book => {
            const description = book.bookDescription ?
                (book.bookDescription.length > 50 ?
                    book.bookDescription.substring(0, 50) + '...' :
                    book.bookDescription) :
                'No description';

            const row = `
                <tr>
                    <td>
                        ${book.bookImage ?
                `<img src="${book.bookImage}" class="book-image" alt="${book.bookTitle}"
                                 onerror="this.src='https://via.placeholder.com/50x70?text=No+Image'">` :
                '<i class="fas fa-book fa-2x text-muted"></i>'}
                    </td>
                    <td>${book.bookTitle}</td>
                    <td>${description}</td>
                    <td>Rs. ${book.bookPrice.toFixed(2)}</td>
                    <td>${book.bookQuantity}</td>
                    <td>${book.bookAuthor?.authorName || 'Unknown'}</td>
                    <td>${book.bookCategory?.categoryName || 'Unknown'}</td>
                    <td>${book.bookPublisher?.publisherName || 'None'}</td>
                    <td class="action-buttons">
                        ${getActionButtons(book.bookId)}
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        // Add event listeners to action buttons
        $('.edit-book').on('click', function() {
            showEditModal($(this).data('id'));
        });

        $('.delete-book').on('click', function() {
            showDeleteModal($(this).data('id'));
        });
    }

    function getActionButtons(bookId) {
        const role = localStorage.getItem('role');
        let buttons = '';

        if (role === 'ADMIN' || role === 'EMPLOYEE') {
            buttons += `
                <button class="btn btn-sm btn-warning edit-book" data-id="${bookId}" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
            `;
        }

        if (role === 'ADMIN') {
            buttons += `
                <button class="btn btn-sm btn-danger delete-book" data-id="${bookId}" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        }

        return buttons;
    }

    function filterBooks() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        if (!searchTerm) {
            displayBooks(allBooks);
            return;
        }

        const filteredBooks = allBooks.filter(book =>
            book.bookTitle.toLowerCase().includes(searchTerm) ||
            (book.bookDescription && book.bookDescription.toLowerCase().includes(searchTerm)) ||
            (book.bookAuthor?.authorName && book.bookAuthor.authorName.toLowerCase().includes(searchTerm)) ||
            (book.bookCategory?.categoryName && book.bookCategory.categoryName.toLowerCase().includes(searchTerm)) ||
            (book.bookPublisher?.publisherName && book.bookPublisher.publisherName.toLowerCase().includes(searchTerm))
        );

        displayBooks(filteredBooks);
    }

    // Set up delete confirmation
    $('#confirmDeleteBtn').on('click', deleteBook);
</script>
</body>
</html>