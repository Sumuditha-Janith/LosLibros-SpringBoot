<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Categories - LosLibros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            display: none;
            background-color: #f8f9fa;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container" style="margin-top: 80px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Categories</h2>
        <span class="badge bg-primary" id="userRoleInfo"></span>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" id="addCategoryBtn">
            <i class="fas fa-plus me-1"></i> Add New Category
        </button>
        <div class="d-flex gap-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Search categories..." style="width: 250px;">
            <button class="btn btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div class="alert alert-info" id="loadingAlert">
        <i class="fas fa-spinner fa-spin me-2"></i> Loading categories...
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="categoriesTable">
            <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Number of Books</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Categories will be populated here -->
            </tbody>
        </table>
    </div>

    <div class="alert alert-warning" id="noCategoriesAlert" style="display: none;">
        <i class="fas fa-exclamation-circle me-2"></i> No categories found.
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">Save Category</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the category "<span id="deleteCategoryName"></span>"?</p>
                <p class="text-danger">This action cannot be undone. All books in this category will need to be reassigned.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/api.js"></script>
<script src="../js/navbar.js"></script>
<script>
    let currentCategoryId = null;
    let allCategories = [];

    $(document).ready(function() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = 'signIn.html';
            return;
        }

        // Show page content
        $('body').show();
        $('#userRoleInfo').text(`Role: ${role}`);

        // Hide add button for USER role
        if (role === 'USER') {
            $('#addCategoryBtn').hide();
        }

        // Load categories data
        loadCategories();

        // Set up event listeners
        $('#addCategoryBtn').on('click', showAddModal);
        $('#saveCategoryBtn').on('click', saveCategory);
        $('#refreshBtn').on('click', loadCategories);
        $('#searchInput').on('keyup', filterCategories);

        // Initialize modals
        const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // Handle modal hidden event
        $('#categoryModal').on('hidden.bs.modal', function() {
            $('#categoryForm')[0].reset();
            $('#categoryId').val('');
            currentCategoryId = null;
        });
    });

    function showAddModal() {
        $('#modalTitle').text('Add New Category');
        const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        categoryModal.show();
    }

    function showEditModal(categoryId) {
        const category = allCategories.find(c => c.categoryId === categoryId);
        if (!category) return;

        $('#modalTitle').text('Edit Category');
        $('#categoryId').val(category.categoryId);
        $('#categoryName').val(category.categoryName);

        const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
        categoryModal.show();
    }

    function showDeleteModal(categoryId) {
        const category = allCategories.find(c => c.categoryId === categoryId);
        if (!category) return;

        $('#deleteCategoryName').text(category.categoryName);
        currentCategoryId = categoryId;

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function saveCategory() {
        const categoryId = $('#categoryId').val();
        const categoryData = {
            categoryName: $('#categoryName').val()
        };

        if (!categoryData.categoryName) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Please fill in the category name',
                confirmButtonColor: '#0d6efd'
            });
            return;
        }

        const url = categoryId ? `/api/v1/categories/${categoryId}` : '/api/v1/categories/save';
        const method = categoryId ? 'PUT' : 'POST';

        makeApiCall(url, method, categoryData)
            .then(newCategory => {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: `Category ${categoryId ? 'updated' : 'added'} successfully!`,
                    confirmButtonColor: '#0d6efd'
                });
                $('#categoryModal').modal('hide');
                loadCategories();
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: categoryId ? 'Update Failed' : 'Add Failed',
                    text: `Failed to ${categoryId ? 'update' : 'add'} category: ${error}`,
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    function deleteCategory() {
        if (!currentCategoryId) return;

        makeApiCall(`/api/v1/categories/${currentCategoryId}`, 'DELETE')
            .then(function() {
                Swal.fire({
                    icon: 'success',
                    title: 'Deleted!',
                    text: 'Category deleted successfully!',
                    confirmButtonColor: '#0d6efd'
                });
                $('#deleteModal').modal('hide');
                loadCategories();
            })
            .catch(function(error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Delete Failed',
                    text: 'Failed to delete category: ' + error,
                    confirmButtonColor: '#0d6efd'
                });
            });
    }

    function loadCategories() {
        $('#loadingAlert').show();
        $('#noCategoriesAlert').hide();

        makeApiCall('/api/v1/categories/getAllCat', 'GET')
            .then(function(categories) {
                allCategories = categories;
                displayCategories(categories);
                $('#loadingAlert').hide();
            })
            .catch(function(error) {
                console.error('Failed to load categories:', error);
                $('#loadingAlert').hide();
                $('#noCategoriesAlert').show();
            });
    }

    function displayCategories(categories) {
        const tbody = $('#categoriesTable tbody');
        tbody.empty();

        if (categories.length === 0) {
            $('#noCategoriesAlert').show();
            return;
        }

        categories.forEach(function(category) {
            const row = `
                    <tr>
                        <td>${category.categoryName}</td>
                        <td>${category.bookCount || 0}</td>
                        <td class="action-buttons">
                            ${getActionButtons(category.categoryId)}
                        </td>
                    </tr>
                `;
            tbody.append(row);
        });

        // Add event listeners to action buttons
        $('.edit-category').on('click', function() {
            showEditModal($(this).data('id'));
        });

        $('.delete-category').on('click', function() {
            showDeleteModal($(this).data('id'));
        });
    }

    function getActionButtons(categoryId) {
        const role = localStorage.getItem('role');
        let buttons = '';

        if (role === 'ADMIN' || role === 'EMPLOYEE') {
            buttons += `
                    <button class="btn btn-sm btn-warning edit-category" data-id="${categoryId}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
        }

        if (role === 'ADMIN') {
            buttons += `
                    <button class="btn btn-sm btn-danger delete-category" data-id="${categoryId}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
        }

        return buttons;
    }

    function filterCategories() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        if (!searchTerm) {
            displayCategories(allCategories);
            return;
        }

        const filteredCategories = allCategories.filter(function(category) {
            return category.categoryName.toLowerCase().includes(searchTerm);
        });

        displayCategories(filteredCategories);
    }

    // Set up delete confirmation
    $('#confirmDeleteBtn').on('click', deleteCategory);
</script>
</body>
</html>