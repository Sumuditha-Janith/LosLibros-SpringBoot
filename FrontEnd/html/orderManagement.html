<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - LosLibros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: none;
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-out-for-delivery {
            background-color: #cce5ff;
            color: #004085;
        }
        .status-delivered {
            background-color: #d4edda;
            color: #155724;
        }
        .status-returned {
            background-color: #f8d7da;
            color: #721c24;
        }
        .order-card {
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        .order-details {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container" style="margin-top: 80px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Order Management</h2>
        <div>
            <span class="badge bg-primary" id="userRoleInfo"></span>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary filter-btn active" data-status="all">
                            All Orders
                        </button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-status="PENDING">
                            Pending
                        </button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-status="OUT_FOR_DELIVERY">
                            Out for Delivery
                        </button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-status="DELIVERED">
                            Delivered
                        </button>
                        <button type="button" class="btn btn-outline-primary filter-btn" data-status="RETURNED">
                            Returned
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search orders..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-info" id="loadingAlert">
        <i class="fas fa-spinner fa-spin me-2"></i> Loading orders...
    </div>

    <div id="ordersContainer">
        <!-- Orders will be populated here -->
    </div>

    <div class="alert alert-warning" id="noOrdersAlert" style="display: none;">
        <i class="fas fa-exclamation-circle me-2"></i> No orders found matching your criteria.
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details - #<span id="modalOrderId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Customer Information</h6>
                        <p><strong>Name:</strong> <span id="modalCustomerName"></span></p>
                        <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
                        <p><strong>Address:</strong> <span id="modalCustomerAddress"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Order Date:</strong> <span id="modalOrderDate"></span></p>
                        <p><strong>Status:</strong> <span id="modalOrderStatus"></span></p>
                        <p><strong>Total Amount:</strong> $<span id="modalOrderTotal"></span></p>
                    </div>
                </div>

                <h6>Order Items</h6>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Book</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody id="modalOrderItems">
                        <!-- Order items will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="mt-4">
                    <label for="statusSelect" class="form-label"><strong>Update Status:</strong></label>
                    <select class="form-select" id="statusSelect">
                        <option value="PENDING">PENDING</option>
                        <option value="OUT_FOR_DELIVERY">OUT FOR DELIVERY</option>
                        <option value="DELIVERED">DELIVERED</option>
                        <option value="RETURNED">RETURNED</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/navbar.js"></script>
<script>
    let allOrders = [];
    let currentOrderId = null;

    $(document).ready(function() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = 'signIn.html';
            return;
        }

        // Check if user has permission (ADMIN or EMPLOYEE)
        if (role !== 'ADMIN' && role !== 'EMPLOYEE') {
            alert('Access denied. You need admin or employee privileges to access this page.');
            window.location.href = role === 'USER' ? 'userDashboard.html' : 'signIn.html';
            return;
        }

        // Show page content
        $('body').show();
        $('#userRoleInfo').text(`Role: ${role}`);

        // Load orders
        loadOrders();

        // Set up event listeners
        $('.filter-btn').on('click', function() {
            $('.filter-btn').removeClass('active');
            $(this).addClass('active');
            filterOrders($(this).data('status'));
        });

        $('#searchInput').on('keyup', function() {
            filterOrders($('.filter-btn.active').data('status'), $(this).val());
        });

        $('#updateStatusBtn').on('click', updateOrderStatus);
    });

    function loadOrders() {
        $('#loadingAlert').show();
        $('#ordersContainer').empty();

        makeApiCall('/api/v1/orders/all', 'GET')
            .then(orders => {
                allOrders = orders;
                displayOrders(orders);
                $('#loadingAlert').hide();
            })
            .catch(error => {
                console.error('Failed to load orders:', error);
                $('#loadingAlert').hide();
                $('#noOrdersAlert').show();
            });
    }

    function displayOrders(orders) {
        const container = $('#ordersContainer');
        container.empty();

        if (orders.length === 0) {
            $('#noOrdersAlert').show();
            return;
        }

        $('#noOrdersAlert').hide();

        orders.forEach(order => {
            const orderDate = new Date(order.orderDate).toLocaleDateString();
            const statusClass = getStatusClass(order.orderStatus);

            const orderCard = `
                <div class="card mb-3 order-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <h6 class="card-title">Order #${order.id}</h6>
                                <small class="text-muted">${orderDate}</small>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-0"><strong>Customer:</strong> ${order.username}</p>
                                <small class="text-muted">${order.userEmail}</small>
                            </div>
                            <div class="col-md-3">
                                <p class="mb-0 text-truncate"><strong>Address:</strong> ${order.userAddress}</p>
                            </div>
                            <div class="col-md-2">
                                <span class="status-badge ${statusClass}">${order.orderStatus}</span>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-0"><strong>Total:</strong> $${order.totalAmount.toFixed(2)}</p>
                            </div>
                            <div class="col-md-1 text-end">
                                <button class="btn btn-sm btn-outline-primary view-order-btn" data-id="${order.id}">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.append(orderCard);
        });

        // Add event listeners to view buttons
        $('.view-order-btn').on('click', function() {
            const orderId = $(this).data('id');
            showOrderDetails(orderId);
        });
    }

    function getStatusClass(status) {
        switch(status) {
            case 'PENDING': return 'status-pending';
            case 'OUT_FOR_DELIVERY': return 'status-out-for-delivery';
            case 'DELIVERED': return 'status-delivered';
            case 'RETURNED': return 'status-returned';
            default: return '';
        }
    }

    function filterOrders(status, searchTerm = '') {
        let filteredOrders = allOrders;

        if (status !== 'all') {
            filteredOrders = filteredOrders.filter(order => order.orderStatus === status);
        }

        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filteredOrders = filteredOrders.filter(order =>
                order.username.toLowerCase().includes(term) ||
                order.userEmail.toLowerCase().includes(term) ||
                order.userAddress.toLowerCase().includes(term) ||
                order.id.toString().includes(term)
            );
        }

        displayOrders(filteredOrders);
    }

    function showOrderDetails(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;

        currentOrderId = orderId;

        $('#modalOrderId').text(order.id);
        $('#modalCustomerName').text(order.username);
        $('#modalCustomerEmail').text(order.userEmail);
        $('#modalCustomerAddress').text(order.userAddress);
        $('#modalOrderDate').text(new Date(order.orderDate).toLocaleString());
        $('#modalOrderStatus').html(`<span class="status-badge ${getStatusClass(order.orderStatus)}">${order.orderStatus}</span>`);
        $('#modalOrderTotal').text(order.totalAmount.toFixed(2));
        $('#statusSelect').val(order.orderStatus);

        // Populate order items
        const itemsContainer = $('#modalOrderItems');
        itemsContainer.empty();

        order.items.forEach(item => {
            const itemRow = `
                <tr>
                    <td>${item.bookTitle}</td>
                    <td>${item.quantity}</td>
                    <td>$${item.price.toFixed(2)}</td>
                    <td>$${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `;
            itemsContainer.append(itemRow);
        });

        $('#orderDetailsModal').modal('show');
    }

    function updateOrderStatus() {
        const newStatus = $('#statusSelect').val();

        // Use query parameter instead of request body
        makeApiCall(`/api/v1/orders/${currentOrderId}/status?status=${newStatus}`, 'PUT')
            .then(updatedOrder => {
                // Update the order in our local list
                const index = allOrders.findIndex(o => o.id === currentOrderId);
                if (index !== -1) {
                    allOrders[index] = updatedOrder;
                }

                // Refresh the display
                filterOrders($('.filter-btn.active').data('status'), $('#searchInput').val());

                // Close the modal
                $('#orderDetailsModal').modal('hide');

                alert('Order status updated successfully!');
            })
            .catch(error => {
                console.error('Failed to update order status:', error);
                alert('Failed to update order status: ' + error);
            });
    }
</script>
</body>
</html>