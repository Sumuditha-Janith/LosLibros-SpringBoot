<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Authors - LosLibros</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            display: none;
            background-color: #f8f9fa;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container" style="margin-top: 80px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Manage Authors</h2>
        <span class="badge bg-primary" id="userRoleInfo"></span>
    </div>

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" id="addAuthorBtn">
            <i class="fas fa-plus me-1"></i> Add New Author
        </button>
        <div class="d-flex gap-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Search authors..." style="width: 250px;">
            <button class="btn btn-outline-secondary" id="refreshBtn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <div class="alert alert-info" id="loadingAlert">
        <i class="fas fa-spinner fa-spin me-2"></i> Loading authors...
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="authorsTable">
            <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Number of Books</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Authors will be populated here -->
            </tbody>
        </table>
    </div>

    <div class="alert alert-warning" id="noAuthorsAlert" style="display: none;">
        <i class="fas fa-exclamation-circle me-2"></i> No authors found.
    </div>
</div>

<!-- Add/Edit Author Modal -->
<div class="modal fade" id="authorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Author</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="authorForm">
                    <input type="hidden" id="authorId">
                    <div class="mb-3">
                        <label for="authorName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="authorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="authorDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="authorDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAuthorBtn">Save Author</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the author "<span id="deleteAuthorName"></span>"?</p>
                <p class="text-danger">This action cannot be undone. All books by this author will need to be reassigned.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/navbar.js"></script>
<script>
    let currentAuthorId = null;
    let allAuthors = [];

    $(document).ready(function() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');

        if (!token) {
            window.location.href = 'signIn.html';
            return;
        }

        // Show page content
        $('body').show();
        $('#userRoleInfo').text(`Role: ${role}`);

        // Hide add button for USER role
        if (role === 'USER') {
            $('#addAuthorBtn').hide();
        }

        // Load authors data
        loadAuthors();

        // Set up event listeners
        $('#addAuthorBtn').on('click', showAddModal);
        $('#saveAuthorBtn').on('click', saveAuthor);
        $('#refreshBtn').on('click', loadAuthors);
        $('#searchInput').on('keyup', filterAuthors);

        // Initialize modals
        const authorModal = new bootstrap.Modal(document.getElementById('authorModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // Handle modal hidden event
        $('#authorModal').on('hidden.bs.modal', function() {
            $('#authorForm')[0].reset();
            $('#authorId').val('');
            currentAuthorId = null;
        });
    });

    function showAddModal() {
        $('#modalTitle').text('Add New Author');
        const authorModal = new bootstrap.Modal(document.getElementById('authorModal'));
        authorModal.show();
    }

    function showEditModal(authorId) {
        const author = allAuthors.find(a => a.authorId === authorId);
        if (!author) return;

        $('#modalTitle').text('Edit Author');
        $('#authorId').val(author.authorId);
        $('#authorName').val(author.authorName);
        $('#authorDescription').val(author.authorDescription || '');

        const authorModal = new bootstrap.Modal(document.getElementById('authorModal'));
        authorModal.show();
    }

    function showDeleteModal(authorId) {
        const author = allAuthors.find(a => a.authorId === authorId);
        if (!author) return;

        $('#deleteAuthorName').text(author.authorName);
        currentAuthorId = authorId;

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function saveAuthor() {
        const authorId = $('#authorId').val();
        const authorData = {
            authorName: $('#authorName').val(),
            authorDescription: $('#authorDescription').val() || ''
        };

        if (!authorData.authorName) {
            alert('Please fill in the author name');
            return;
        }

        const url = authorId ? `/api/v1/authors/${authorId}` : '/api/v1/authors/save';
        const method = authorId ? 'PUT' : 'POST';

        makeApiCall(url, method, authorData)
            .then(newAuthor => {
                alert(`Author ${authorId ? 'updated' : 'added'} successfully!`);
                $('#authorModal').modal('hide');
                loadAuthors();
            })
            .catch(error => {
                alert(`Failed to ${authorId ? 'update' : 'add'} author: ` + error);
            });
    }

    function deleteAuthor() {
        if (!currentAuthorId) return;

        makeApiCall(`/api/v1/authors/${currentAuthorId}`, 'DELETE')
            .then(() => {
                alert('Author deleted successfully!');
                $('#deleteModal').modal('hide');
                loadAuthors();
            })
            .catch(error => {
                alert('Failed to delete author: ' + error);
            });
    }

    function loadAuthors() {
        $('#loadingAlert').show();
        $('#noAuthorsAlert').hide();

        makeApiCall('/api/v1/authors/getAllAuth', 'GET')
            .then(authors => {
                allAuthors = authors;
                displayAuthors(authors);
                $('#loadingAlert').hide();
            })
            .catch(error => {
                console.error('Failed to load authors:', error);
                $('#loadingAlert').hide();
                $('#noAuthorsAlert').show();
            });
    }

    function displayAuthors(authors) {
        const tbody = $('#authorsTable tbody');
        tbody.empty();

        if (authors.length === 0) {
            $('#noAuthorsAlert').show();
            return;
        }

        authors.forEach(author => {
            const row = `
                    <tr>
                        <td>${author.authorName}</td>
                        <td>${author.authorDescription || 'No description'}</td>
                        <td>${author.bookCount || 0}</td>
                        <td class="action-buttons">
                            ${getActionButtons(author.authorId)}
                        </td>
                    </tr>
                `;
            tbody.append(row);
        });

        // Add event listeners to action buttons
        $('.edit-author').on('click', function() {
            showEditModal($(this).data('id'));
        });

        $('.delete-author').on('click', function() {
            showDeleteModal($(this).data('id'));
        });
    }

    function getActionButtons(authorId) {
        const role = localStorage.getItem('role');
        let buttons = '';

        if (role === 'ADMIN' || role === 'EMPLOYEE') {
            buttons += `
                    <button class="btn btn-sm btn-warning edit-author" data-id="${authorId}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
        }

        if (role === 'ADMIN') {
            buttons += `
                    <button class="btn btn-sm btn-danger delete-author" data-id="${authorId}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
        }

        return buttons;
    }

    function filterAuthors() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        if (!searchTerm) {
            displayAuthors(allAuthors);
            return;
        }

        const filteredAuthors = allAuthors.filter(author =>
            author.authorName.toLowerCase().includes(searchTerm) ||
            (author.authorDescription && author.authorDescription.toLowerCase().includes(searchTerm))
        );

        displayAuthors(filteredAuthors);
    }

    // Set up delete confirmation
    $('#confirmDeleteBtn').on('click', deleteAuthor);
</script>
</body>
</html>