<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders - LosLibros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      padding-bottom: 80px;
      background-color: #f8f9fa;
      display: none;
    }
    .order-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
      transition: transform 0.3s;
    }
    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .order-header {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }
    .order-status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    #ordHistoryText{
      margin-top: 30px;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-delivered {
      background-color: #d4edda;
      color: #155724;
    }
    .status-out-for-delivery {
      background-color: #cce5ff;
      color: #004085;
    }
    .status-returned {
      background-color: #f8d7da;
      color: #721c24;
    }
    .book-item {
      padding: 10px 0;
      border-bottom: 1px solid #f8f9fa;
    }
    .book-item:last-child {
      border-bottom: none;
    }
    .empty-orders {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }
    .loading-spinner {
      text-align: center;
      padding: 30px;
    }
  </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-history me-2" id="ordHistoryText"></i>My Order History</h2>
    <span class="badge bg-primary" id="ordersCount">0 orders</span>
  </div>

  <div class="card">
    <div class="card-body">
      <div id="loadingOrders" class="loading-spinner">
        <i class="fas fa-spinner fa-spin fa-2x me-2"></i> Loading your orders...
      </div>

      <div id="ordersContainer">
        <!-- Orders will be populated here -->
      </div>

      <div id="emptyOrders" class="empty-orders" style="display: none;">
        <i class="fas fa-box-open fa-3x mb-3"></i>
        <h4>No orders yet</h4>
        <p>You haven't placed any orders. Start shopping to see your order history here.</p>
        <a href="userDashboard.html" class="btn btn-primary mt-2">
          <i class="fas fa-book me-1"></i> Browse Books
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).ready(function() {
    // Load the navbar
    $("#navbar-container").load("userNavbar.html", function() {
      // Initialize navbar functionality after it's loaded
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');

      if (!token) {
        window.location.href = 'signIn.html';
        return;
      }

      // Display username if available
      if (username) {
        $('#usernameDisplay').text(username);
      }

      // Logout functionality
      $('#logoutBtn').on('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        localStorage.removeItem('role');
        window.location.href = '../index.html';
      });

      // Profile link functionality
      $('#profileLink').on('click', function(e) {
        e.preventDefault();
        alert('Profile customization feature will be implemented here.');
      });

      // Show page content after navbar is loaded
      $('body').show();

      // Now load orders
      loadOrders();
    });
  });

  function loadOrders() {
    const token = localStorage.getItem('token');

    if (!token) {
      window.location.href = 'signIn.html';
      return;
    }

    fetch("http://localhost:8080/api/v1/orders/my", {
      headers: {
        "Authorization": "Bearer " + token
      }
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to fetch orders');
              }
              return response.json();
            })
            .then(orders => {
              $("#loadingOrders").hide();

              if (orders.length === 0) {
                $("#emptyOrders").show();
                $("#ordersCount").text("0 orders");
                return;
              }

              $("#ordersCount").text(orders.length + " order" + (orders.length !== 1 ? "s" : ""));

              let ordersHTML = "";
              orders.forEach(order => {
                // Format order date
                const orderDate = new Date(order.orderDate);
                const formattedDate = orderDate.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });

                // Get status class
                let statusClass = "status-pending";
                if (order.orderStatus === "DELIVERED") statusClass = "status-delivered";
                else if (order.orderStatus === "OUT_FOR_DELIVERY") statusClass = "status-out-for-delivery";
                else if (order.orderStatus === "RETURNED") statusClass = "status-returned";

                // Build items list
                let itemsHTML = "";
                order.items.forEach(item => {
                  itemsHTML += `
            <div class="book-item">
              <div class="d-flex justify-content-between">
                <div class="book-title">${item.bookTitle}</div>
                <div class="book-quantity">x${item.quantity}</div>
              </div>
              <div class="d-flex justify-content-between text-muted">
                <small>Unit price: Rs. ${item.price.toFixed(2)}</small>
                <small>Total: Rs. ${(item.price * item.quantity).toFixed(2)}</small>
              </div>
            </div>
          `;
                });

                ordersHTML += `
          <div class="order-card">
            <div class="order-header d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">Order #${order.id}</h5>
                <small class="text-muted">Placed on ${formattedDate}</small>
              </div>
              <div>
                <span class="order-status ${statusClass}">${order.orderStatus.replace(/_/g, ' ')}</span>
              </div>
            </div>
            <div class="order-items">
              ${itemsHTML}
            </div>
            <div class="order-footer d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
              <div class="order-address">
                <small class="text-muted">Shipped to: ${order.userAddress}</small>
              </div>
              <div class="order-total">
                <strong>Total: Rs. ${order.totalAmount.toFixed(2)}</strong>
              </div>
            </div>
          </div>
        `;
              });

              $("#ordersContainer").html(ordersHTML);
            })
            .catch(error => {
              console.error("Error loading orders:", error);
              $("#loadingOrders").html(`
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Failed to load orders. Please try again later.
        </div>
      `);
            });
  }
</script>
</body>
</html>