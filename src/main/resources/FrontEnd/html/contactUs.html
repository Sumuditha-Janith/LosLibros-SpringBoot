<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Us - LosLibros</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .message-card {
      border-left: 4px solid #007bff;
      transition: transform 0.2s;
    }
    .message-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .message-card.responded {
      border-left-color: #28a745;
    }
    .message-card.closed {
      border-left-color: #6c757d;
    }
    .staff-reply {
      background-color: #f8f9fa;
      border-left: 4px solid #28a745;
      margin-left: 20px;
    }
    .user-message {
      background-color: #ffffff;
    }
    .user-reply {
      background-color: #e8f4fd;
      border-left: 4px solid #17a2b8;
      margin-left: 20px;
    }
    .timestamp {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .thread-container {
      max-height: 400px;
      overflow-y: auto;
    }
    .status-badge {
      font-size: 0.8rem;
    }
    .conversation-item {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-envelope me-2"></i>Contact Support</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
          <i class="fas fa-plus me-1"></i> New Message
        </button>
      </div>

      <div class="alert alert-info" id="loadingAlert">
        <i class="fas fa-spinner fa-spin me-2"></i> Loading your messages...
      </div>

      <div id="messagesContainer">
        <!-- Messages will be populated here -->
      </div>

      <div class="alert alert-warning" id="noMessagesAlert" style="display: none;">
        <i class="fas fa-inbox me-2"></i> You haven't sent any messages yet.
      </div>
    </div>
  </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Message to Support</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newMessageForm">
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input type="text" class="form-control" id="subject" required>
          </div>
          <div class="mb-3">
            <label for="message" class="form-label">Message</label>
            <textarea class="form-control" id="message" rows="5" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="sendMessageBtn">Send Message</button>
      </div>
    </div>
  </div>
</div>

<!-- Message Thread Modal -->
<div class="modal fade" id="messageThreadModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="threadTitle">Message Thread</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Thread Status Info -->
        <div class="alert alert-info" id="threadStatusInfo">
          <i class="fas fa-info-circle me-2"></i>
          <span id="statusText">Loading thread status...</span>
        </div>

        <div class="thread-container mb-3" id="threadContainer">
          <!-- Thread messages will be populated here -->
        </div>

        <!-- Reply Section (show only if thread is not closed) -->
        <div id="replySection" style="display: none;">
          <hr>
          <h6>Continue this conversation</h6>
          <div class="mb-2">
            <textarea class="form-control" id="replyMessage" rows="3" placeholder="Type your reply..."></textarea>
          </div>
          <button class="btn btn-primary" id="sendReplyBtn">
            <i class="fas fa-reply me-1"></i> Send Reply
          </button>
        </div>

        <!-- Closed Thread Message -->
        <div id="closedThreadMessage" style="display: none;">
          <div class="alert alert-secondary text-center">
            <i class="fas fa-lock me-2"></i>
            This conversation has been closed by staff. You cannot reply anymore.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../js/api.js"></script>
<script>
  let currentThreadId = null;
  let currentThreadStatus = null;

  $(document).ready(function() {
    // Load navbar
    $("#navbar-container").load("userNavbar.html", function() {
      initializeNavbar();
      loadUserMessages();
    });

    // Send new message
    $('#sendMessageBtn').on('click', sendNewMessage);

    // Send reply
    $('#sendReplyBtn').on('click', sendReply);
  });

  function initializeNavbar() {
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');

    if (!token) {
      window.location.href = 'signIn.html';
      return;
    }

    if (username) {
      $('#usernameDisplay').text(username);
    }

    $('#logoutBtn').on('click', function(e) {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = '../index.html';
    });
  }

  function loadUserMessages() {
    $('#loadingAlert').show();
    $('#noMessagesAlert').hide();

    makeApiCall('/api/v1/contact/messages/my-messages', 'GET')
            .then(response => {
              $('#loadingAlert').hide();
              console.log('Messages API response:', response);

              if (response && response.data) {
                displayMessages(response.data);
              } else {
                console.error('Invalid response structure:', response);
                $('#messagesContainer').html('<div class="alert alert-danger">Invalid response from server</div>');
              }
            })
            .catch(error => {
              $('#loadingAlert').hide();
              console.error('Failed to load messages:', error);
              let errorMsg = 'Failed to load messages';
              if (error.responseData && error.responseData.message) {
                errorMsg = error.responseData.message;
              } else if (error.message) {
                errorMsg = error.message;
              }
              $('#messagesContainer').html(`<div class="alert alert-danger">${errorMsg}</div>`);
            });
  }

  function displayMessages(messages) {
    const container = $('#messagesContainer');
    container.empty();

    console.log('Displaying messages:', messages);

    if (!messages || messages.length === 0) {
      $('#noMessagesAlert').show();
      return;
    }

    // Filter to show only parent messages (not replies)
    const parentMessages = messages.filter(msg => !msg.parentMessageId);

    parentMessages.forEach(message => {
      const statusBadge = getStatusBadge(message.status);
      const canEdit = message.canEdit;
      const isClosed = message.status === 'CLOSED';

      // Get all replies for this message
      const replies = messages.filter(msg => msg.parentMessageId === message.id);
      const lastReply = replies.length > 0 ? replies[replies.length - 1] : null;

      const messageCard = `
        <div class="card message-card mb-3 ${message.status ? message.status.toLowerCase() : ''}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <h5 class="card-title mb-0 me-2">${message.subject || 'No Subject'}</h5>
                  ${statusBadge}
                </div>
                <p class="card-text">${truncateText(message.message, 100)}</p>
                <div class="timestamp">
                  <i class="fas fa-clock me-1"></i>Started on ${formatDateTime(message.createdAt)}
                  ${lastReply ?
              `<br><i class="fas fa-comments me-1"></i>Last activity: ${formatDateTime(lastReply.createdAt)}` :
              ''
      }
                  ${message.staffName ?
              `<br><i class="fas fa-headset me-1"></i>Handled by: ${message.staffName}` :
              ''
      }
                  ${replies.length > 0 ?
              `<br><i class="fas fa-exchange-alt me-1"></i>${replies.length} message(s) in this conversation` :
              ''
      }
                </div>
              </div>
              <div class="text-end">
                ${canEdit && !isClosed ?
              `<button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteMessage(${message.id})">
                    <i class="fas fa-trash"></i>
                  </button>` :
              ''
      }
              </div>
            </div>
            <button class="btn btn-outline-primary btn-sm mt-2" onclick="viewThread(${message.id})">
              <i class="fas fa-comments me-1"></i> View Conversation
            </button>
            ${!isClosed && message.status === 'RESPONDED' ?
              `<span class="badge bg-warning status-badge ms-2"><i class="fas fa-comment me-1"></i> Awaiting your response</span>` :
              ''
      }
          </div>
        </div>
      `;
      container.append(messageCard);
    });
  }

  function sendNewMessage() {
    const subject = $('#subject').val().trim();
    const messageText = $('#message').val().trim();

    if (!subject || !messageText) {
      Swal.fire({
        icon: 'error',
        title: 'Missing Information',
        text: 'Please fill in both subject and message',
        confirmButtonColor: '#0d6efd'
      });
      return;
    }

    $('#sendMessageBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');

    const request = {
      subject: subject,
      message: messageText
    };

    console.log('Sending message request:', request);

    makeApiCall('/api/v1/contact/messages', 'POST', request)
            .then(response => {
              console.log('Send message response:', response);

              if (response && (response.status === 200 || response.data)) {
                $('#newMessageModal').modal('hide');
                $('#newMessageForm')[0].reset();
                loadUserMessages();
                Swal.fire({
                  icon: 'success',
                  title: 'Message Sent!',
                  text: 'Message sent successfully! Staff will respond soon.',
                  confirmButtonColor: '#0d6efd'
                });
              } else {
                throw new Error(response?.message || 'Invalid response from server');
              }
            })
            .catch(error => {
              console.error('Full error details:', error);

              let errorMessage = 'Failed to send message';

              if (error.responseData) {
                errorMessage = error.responseData.message || error.message;
              } else if (error.message) {
                errorMessage = error.message;
              }

              Swal.fire({
                icon: 'error',
                title: 'Send Failed',
                text: 'Failed to send message: ' + errorMessage,
                confirmButtonColor: '#0d6efd'
              });
            })
            .finally(() => {
              $('#sendMessageBtn').prop('disabled', false).html('Send Message');
            });
  }

  function viewThread(messageId) {
    currentThreadId = messageId;
    console.log('Viewing thread for message ID:', messageId);

    makeApiCall(`/api/v1/contact/messages/${messageId}/thread`, 'GET')
            .then(response => {
              console.log('Thread API response:', response);

              if (response && response.data) {
                displayThread(response.data);
                $('#messageThreadModal').modal('show');
              } else {
                throw new Error('Invalid thread response structure: ' + JSON.stringify(response));
              }
            })
            .catch(error => {
              console.error('Failed to load thread:', error);
              let errorMsg = 'Failed to load message thread';
              if (error.responseData && error.responseData.message) {
                errorMsg = error.responseData.message;
              } else if (error.message) {
                errorMsg = error.message;
              }
              Swal.fire({
                icon: 'error',
                title: 'Load Failed',
                text: errorMsg,
                confirmButtonColor: '#0d6efd'
              });
            });
  }

  function displayThread(thread) {
    console.log('Displaying thread:', thread);

    const container = $('#threadContainer');
    const originalMessage = thread.originalMessage;
    const replies = thread.replies || [];
    currentThreadStatus = originalMessage.status;

    $('#threadTitle').text(`Conversation: ${originalMessage.subject}`);

    // Update thread status info
    const statusInfo = $('#threadStatusInfo');
    const statusText = $('#statusText');

    switch(originalMessage.status) {
      case 'PENDING':
        statusInfo.removeClass('alert-info alert-warning alert-secondary').addClass('alert-info');
        statusText.html('<i class="fas fa-clock me-1"></i> This conversation is pending. Staff will respond soon.');
        break;
      case 'RESPONDED':
        statusInfo.removeClass('alert-info alert-warning alert-secondary').addClass('alert-warning');
        statusText.html('<i class="fas fa-comment me-1"></i> Staff has responded. You can continue the conversation.');
        break;
      case 'CLOSED':
        statusInfo.removeClass('alert-info alert-warning alert-secondary').addClass('alert-secondary');
        statusText.html('<i class="fas fa-lock me-1"></i> This conversation has been closed by staff.');
        break;
    }

    let threadHTML = '';

    // Original message
    threadHTML += `
      <div class="conversation-item user-message">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <strong><i class="fas fa-user me-1"></i> You</strong>
          <small class="timestamp">${formatDateTime(originalMessage.createdAt)}</small>
        </div>
        <p class="mb-1">${originalMessage.message}</p>
        <small class="text-muted">Original message</small>
      </div>
    `;

    // Replies
    if (replies && replies.length > 0) {
      replies.forEach(reply => {
        const isStaffReply = reply.staffId !== null && reply.staffId !== undefined;
        threadHTML += `
          <div class="conversation-item ${isStaffReply ? 'staff-reply' : 'user-reply'}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <strong><i class="fas ${isStaffReply ? 'fa-headset' : 'fa-user'} me-1"></i>
                  ${isStaffReply ? `Staff (${reply.staffName || 'Support'})` : 'You'}
              </strong>
              <small class="timestamp">${formatDateTime(reply.createdAt)}</small>
            </div>
            <p class="mb-1">${reply.message}</p>
            <small class="text-muted">${isStaffReply ? 'Staff response' : 'Your reply'}</small>
          </div>
        `;
      });
    } else {
      threadHTML += `
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>No replies yet. Staff will respond soon.
        </div>
      `;
    }

    container.html(threadHTML);

    // Show/hide reply section based on thread status
    if (originalMessage.status === 'CLOSED') {
      $('#replySection').hide();
      $('#closedThreadMessage').show();
    } else {
      $('#replySection').show();
      $('#closedThreadMessage').hide();
      $('#replyMessage').val('').focus();
    }

    // Scroll to bottom of thread
    container.scrollTop(container[0].scrollHeight);
  }

  function sendReply() {
    const replyText = $('#replyMessage').val().trim();

    if (!replyText) {
      Swal.fire({
        icon: 'error',
        title: 'Missing Message',
        text: 'Please enter a reply message',
        confirmButtonColor: '#0d6efd'
      });
      return;
    }

    $('#sendReplyBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');

    const request = {
      subject: 'Reply to conversation', // This will be ignored for replies
      message: replyText,
      parentMessageId: currentThreadId
    };

    console.log('Sending reply request:', request);

    makeApiCall('/api/v1/contact/messages', 'POST', request)
            .then(response => {
              console.log('Send reply response:', response);

              if (response && (response.status === 200 || response.data)) {
                $('#replyMessage').val('');
                // Refresh the thread to show the new reply
                viewThread(currentThreadId);
                // Refresh the messages list
                loadUserMessages();
              } else {
                throw new Error(response?.message || 'Failed to send reply');
              }
            })
            .catch(error => {
              console.error('Failed to send reply:', error);
              let errorMsg = 'Failed to send reply';
              if (error.responseData && error.responseData.message) {
                errorMsg = error.responseData.message;
              } else if (error.message) {
                errorMsg = error.message;
              }
              Swal.fire({
                icon: 'error',
                title: 'Reply Failed',
                text: errorMsg,
                confirmButtonColor: '#0d6efd'
              });
            })
            .finally(() => {
              $('#sendReplyBtn').prop('disabled', false).html('<i class="fas fa-reply me-1"></i> Send Reply');
            });
  }

  function deleteMessage(messageId) {
    Swal.fire({
      title: 'Delete Conversation?',
      text: 'Are you sure you want to delete this message? This will delete the entire conversation thread.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, delete it!',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        makeApiCall(`/api/v1/contact/messages/${messageId}`, 'DELETE')
                .then(response => {
                  if (response && response.status === 200) {
                    loadUserMessages();
                    $('#messageThreadModal').modal('hide');
                    Swal.fire({
                      icon: 'success',
                      title: 'Deleted!',
                      text: 'Message and conversation deleted successfully',
                      confirmButtonColor: '#0d6efd'
                    });
                  } else {
                    throw new Error(response?.message || 'Failed to delete message');
                  }
                })
                .catch(error => {
                  console.error('Failed to delete message:', error);
                  let errorMsg = 'Failed to delete message';
                  if (error.responseData && error.responseData.message) {
                    errorMsg = error.responseData.message;
                  } else if (error.message) {
                    errorMsg = error.message;
                  }
                  Swal.fire({
                    icon: 'error',
                    title: 'Delete Failed',
                    text: errorMsg,
                    confirmButtonColor: '#0d6efd'
                  });
                });
      }
    });
  }

  function getStatusBadge(status) {
    const statusConfig = {
      'PENDING': { class: 'bg-warning', text: 'Pending', icon: 'fa-clock' },
      'RESPONDED': { class: 'bg-success', text: 'Active', icon: 'fa-comments' },
      'CLOSED': { class: 'bg-secondary', text: 'Closed', icon: 'fa-lock' }
    };

    const config = statusConfig[status] || statusConfig.PENDING;
    return `<span class="badge ${config.class}"><i class="fas ${config.icon} me-1"></i>${config.text}</span>`;
  }

  function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
  }

  function formatDateTime(dateTime) {
    if (!dateTime) return 'Unknown date';
    return new Date(dateTime).toLocaleString();
  }
</script>
</body>
</html>